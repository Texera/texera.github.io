<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=fonts/vendor/jost/jost-v4-latin-500.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><script async src="https://www.googletagmanager.com/gtag/js?id=G-9VCB7M8KFM"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-9VCB7M8KFM")</script><link rel=stylesheet href=/main.3d66612d630c699ea1ccace42d9da477cb3cbb37c1985c4f4e1bfaa8fee437e79bc9191584e69cb0380cc01ec887ae7e0fc783114068a3d2a3ec3f7a21214c5d.css integrity="sha512-PWZhLWMMaZ6hzKzkLZ2kd8s8uzfBmFxPThv6qP7kN+ebyRkVhOacsDgMwB7Ih65+D8eDEUBoo9Kj7D96ISFMXQ==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>Adding R UDF to Texera: The Journey - Texera</title><meta name=description content="Motivation # The R programming language is widely used in many fields, such as bioinformatics, statistical analysis, and social science. Its popularity is driven by its capabilities and the growing demand for data-related work. Given its significance, our goal was to allow users to seamlessly integrate R into Texera workflows.
We want to enhance Texera by extending its support to include R code and facilitating the creation of R user-defined functions (UDFs) for both the table and tuple APIs."><link rel=canonical href=/blog/adding-r-udf-to-texera-the-journey/><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="Adding R UDF to Texera: The Journey"><meta property="og:description" content="Motivation # The R programming language is widely used in many fields, such as bioinformatics, statistical analysis, and social science. Its popularity is driven by its capabilities and the growing demand for data-related work. Given its significance, our goal was to allow users to seamlessly integrate R into Texera workflows.
We want to enhance Texera by extending its support to include R code and facilitating the creation of R user-defined functions (UDFs) for both the table and tuple APIs."><meta property="og:url" content="/blog/adding-r-udf-to-texera-the-journey/"><meta property="og:site_name" content="Texera"><meta property="article:published_time" content="2024-07-30T08:00:00+00:00"><meta property="article:modified_time" content="2024-07-30T08:00:00+00:00"><meta property="og:image" content="doks.png"><meta property="og:image:alt" content="Texera"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content><meta name=twitter:creator content><meta name=twitter:title content="Adding R UDF to Texera: The Journey"><meta name=twitter:description content><meta name=twitter:image content="doks.png"><meta name=twitter:image:alt content="Adding R UDF to Texera: The Journey"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"/#/schema/organization/1","name":"Texera","url":"/","sameAs":["https://github.com/texera/texera"],"logo":{"@type":"ImageObject","@id":"/#/schema/image/1","url":"/logo-doks.png","width":512,"height":512,"caption":"Texera"},"image":{"@id":"/#/schema/image/1"}},{"@type":"WebSite","@id":"/#/schema/website/1","url":"/","name":"Texera","description":"Texera is a system to support collaborative, ML-centric data analytics as a cloud-based service using GUI-based workflows. It supports scalable computation with a parallel backend engine, and enables advanced AI\/ML techniques.","publisher":{"@id":"/#/schema/organization/1"}},{"@type":"WebPage","@id":"/blog/adding-r-udf-to-texera-the-journey/","url":"/blog/adding-r-udf-to-texera-the-journey/","name":"Adding R UDF to Texera: The Journey","description":"","isPartOf":{"@id":"/#/schema/website/1"},"about":{"@id":"/#/schema/organization/1"},"datePublished":"2024-07-30T08:00:00CET","dateModified":"2024-07-30T08:00:00CET","breadcrumb":{"@id":"/blog/adding-r-udf-to-texera-the-journey/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"/blog/adding-r-udf-to-texera-the-journey/#/schema/image/2"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["/blog/adding-r-udf-to-texera-the-journey/"]}]},{"@type":"BreadcrumbList","@id":"/blog/adding-r-udf-to-texera-the-journey/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"","url":"","name":"Home"}},{"@type":"ListItem","position":3,"item":{"@type":"WebPage","@id":"/blog/","url":"/blog/","name":"Blog"}},{"@type":"ListItem","position":4,"item":{"@id":"/blog/adding-r-udf-to-texera-the-journey/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Article","@id":"/#/schema/article/1","headline":"Adding R UDF to Texera: The Journey","description":"","isPartOf":{"@id":"/blog/adding-r-udf-to-texera-the-journey/"},"mainEntityOfPage":{"@id":"/blog/adding-r-udf-to-texera-the-journey/"},"datePublished":"2024-07-30T08:00:00CET","dateModified":"2024-07-30T08:00:00CET","author":{"@id":"/#/schema/person/2"},"publisher":{"@id":"/#/schema/organization/1"},"image":{"@id":"/blog/adding-r-udf-to-texera-the-journey/#/schema/image/2"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Person","@id":"/#/schema/person/2","name":"Texera Team","sameAs":[]}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"/blog/adding-r-udf-to-texera-the-journey/#/schema/image/2","url":"doks.png","contentUrl":"doks.png","caption":"Adding R UDF to Texera: The Journey"}]}]}</script><meta name=theme-color content="#fff"><link rel=apple-touch-icon sizes=180x180 href=apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=site.webmanifest></head><body class="blog single"><div class=header-bar></div><header class="navbar navbar-expand-md navbar-light doks-navbar"><nav class="container-fluid flex-wrap flex-md-nowrap" aria-label="Main navigation"><a class="navbar-brand p-0 me-auto" href=/ aria-label=Texera>Texera</a>
<button class="btn btn-menu d-block d-md-none order-5" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasDoks aria-controls=offcanvasDoks aria-label="Open main menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button><div class="offcanvas offcanvas-end border-0 py-md-1" tabindex=-1 id=offcanvasDoks data-bs-backdrop=true aria-labelledby=offcanvasDoksLabel><div class="header-bar d-md-none"></div><div class="offcanvas-header d-md-none"><h2 class="h5 offcanvas-title ps-2" id=offcanvasDoksLabel><a class=text-dark href=/>Texera</a></h2><button type=button class="btn-close text-reset me-2" data-bs-dismiss=offcanvas aria-label="Close main menu"></button></div><div class="offcanvas-body px-4"><h3 class="h6 text-uppercase mb-3 d-md-none">Main</h3><ul class="nav flex-column flex-md-row ms-md-n3"><li class=nav-item><a class="nav-link ps-0 py-1 active" href=/blog/>Blog</a></li></ul><hr class="text-black-50 my-4 d-md-none"><h3 class="h6 text-uppercase mb-3 d-md-none">Socials</h3><ul class="nav flex-column flex-md-row ms-md-auto me-md-n5 pe-md-2"><li class=nav-item><a class="nav-link ps-0 py-1" href=/https:/github.com/Texera/texera><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><small class="ms-2 d-md-none">GitHub</small></a></li></ul></div></div></nav></header><div class="wrap container-fluid" role=document><div class=content><div class="row justify-content-center"><div class="col-md-12 col-lg-10 col-xl-8"><article><div class=blog-header><h1>Adding R UDF to Texera: The Journey</h1><p><small>Posted July 30, 2024
by
<a class="stretched-link position-relative" href=/contributors/kevin-wu/>Kevin Wu</a>
and
<a class="stretched-link position-relative" href=/contributors/yicong-huang/>Yicong Huang</a>
from
<a class="stretched-link position-relative" href=/affiliations/computer-science-uc-irvine/>Computer Science, UC Irvine</a>
&nbsp;&dash;&nbsp;
<strong>10&nbsp;min read</strong></small><p></div><p class=lead>In this blog, we discuss the journey taken to implement support for R in Texera. Most notably, we allowed support for table and tuple API with R in Texera.</p><h2 id=motivation>Motivation <a href=#motivation class=anchor aria-hidden=true>#</a></h2><p>The R programming language is widely used in many fields, such as bioinformatics, statistical analysis, and social science. Its popularity is driven by its capabilities and the growing demand for data-related work. Given its significance, our goal was to allow users to seamlessly integrate R into Texera workflows.</p><p>We want to enhance Texera by extending its support to include R code and facilitating the creation of R user-defined functions (UDFs) for both the table and tuple APIs. Doing so would mirror the functionality of Python UDFs, allowing both experienced and new users of Texera to leverage R in their work.</p><h2 id=challenges>Challenges <a href=#challenges class=anchor aria-hidden=true>#</a></h2><p>The current support for R UDF in Texera utilizes Python User-Defined Functions and <code>rpy2</code> (a Python library to use R in Python) to incorporate R code. However, this approach has two limitations, compatability and performance.</p><h3 id=challenge-1-compatibility>Challenge 1: Compatibility <a href=#challenge-1-compatibility class=anchor aria-hidden=true>#</a></h3><p>The first challenge we faced was compatibility issues between R and Python. While <code>rpy2</code> is used to call R from Python, some R packages also internally call Python (e.g. <code>reticulate</code>), causing compatability issues between the two systems. Therefore, we have to make sure any compatability issues were resolved.</p><h3 id=challenge-2-performance>Challenge 2: Performance <a href=#challenge-2-performance class=anchor aria-hidden=true>#</a></h3><p>The second challenge we faced was performance issues in the previous design. Data in Texera travels down from Java to Python to R and then back up in the opposite direction. In the old design, multiple rounds of serialization, deserialization, and copy operations were done on the same data, creating significant overhead. We wanted to eliminate this as much as possible in our new design.</p><h2 id=initial-design>Initial Design <a href=#initial-design class=anchor aria-hidden=true>#</a></h2><h3 id=arrow-flight-and-the-flight-server-client-model>Arrow Flight and the Flight Server-Client Model <a href=#arrow-flight-and-the-flight-server-client-model class=anchor aria-hidden=true>#</a></h3><p>Our original objective was to employ <a href=https://arrow.apache.org/docs/format/Flight.html>Arrow’s Flight module</a> in order to develop a native <a href=https://github.com/apache/arrow/blob/main/r/R/flight.R>R Flight client-server model</a>. The implementation of such a model presents several advantages, paramount among them being the standardization of frameworks for both R UDF and Python UDF. Notably, the Python UDF framework already utilizes its exclusive Arrow Flight client-server model. Adopting a similar approach in R would streamline maintenance and future development. Moreover, Arrow Flight&rsquo;s in-memory data-transfer capabilities significantly enhance performance, facilitating rapid operations within data-intensive workflows.</p><p>However, we discovered the following from the <a href=https://arrow.apache.org/docs/r/articles/flight.html>R Arrow Flight documentation</a>:</p><blockquote><p>&ldquo;At present the arrow package in R does not supply an independent implementation of Arrow Flight&mldr;&rdquo;</p></blockquote><p>Instead, R Arrow Flight operates by invoking methods from the PyArrow Python package, including the code for running a Flight server in R. The most critical issue with this realization is because we wanted R UDF to be executed on the Flight server side. Due to the lack of a native R Flight server, this goal no longer was feasible.</p><p>Regrettably, as of July 14, 2024, there was still no independent implementation of Arrow Flight. Currently, the R Arrow developers have no immediate plans to do so as well, as shown in their biweekly <a href="https://docs.google.com/document/d/1nSIfJw8mfqtvScqvSVqmktpWff80pFmkqiZT7nTtiDo/edit#heading=h.k1ts4kvvl8jq">meeting notes</a>. Consequently, we had to devise an alternative solution for R UDF that leverages Arrow and <code>rpy2</code> alone, eschewing Arrow Flight.</p><h2 id=our-proposed-design>Our Proposed Design <a href=#our-proposed-design class=anchor aria-hidden=true>#</a></h2><p>Our proposed architecture features a three-layered design, where the data flows from Java to Python, then to R, before returning back to Python and Java. An illustration of this architecture is in <em>Figure 1</em> below.</p><figure align=center style=width:100%;max-width:none><img src=./rudf_architecture.png alt style=width:100%><figcaption align=center style=font-size:1.2em><i><b>Figure 1.</b> A concise overview of our proposed design for R UDF.</i></figcaption></figure><p>The core of the design for R UDF relies predominantly on <code>rpy2</code> and <code>rpy2-arrow</code>, with both playing an essential role in ensuring smooth and consistent conversions between Python and R. In this architecture, the Python Worker uses <code>rpy2</code> to run an embedded R session. Data sent downstream from the JVM to Python is then transfered to R using <code>rpy2</code> and <code>rpy2-arrow</code>.</p><p>After the R Executor finishes running, both <code>rpy2</code> and <code>rpy2-arrow</code> convert the returned values from R back to Python. The Python Worker then processes the returned data as necessary and transmits it back upstream to the JVM.</p><h3 id=solving-challenge-1-compatibility>Solving Challenge 1: Compatibility <a href=#solving-challenge-1-compatibility class=anchor aria-hidden=true>#</a></h3><p>As mentioned previously, R and Python had compatabilility issues stemming from the fact that they were able to portions of each other at the same time. The biggest example of this issue pertained to the concurrent use of <code>reticulate</code> (an R package to use Python within R) and <code>rpy2</code>. In 2018, an issue was reported on GitHub highlighting a compatibility problem when using both libraries simultaneously.</p><p>The primary issue was from conflicting lock files between Python and R threads, causing deadlocks as either <code>reticulate</code> or <code>rpy2</code> would lock either the session of Python or R, preventing the other from accessing it. We were pleased to discover that this issue was resolved in 2022, allowing the concurrent use of <code>rpy2</code> and <code>reticulate</code>. Further details can be found <a href=https://github.com/rstudio/reticulate/issues/208>here</a>.</p><p>Additionally, we realized that each block of R code executed through <code>rpy2</code> ran in its own miniature, containerized environment. This isolation helped to avoid compatibility issues with libraries, particularly when testing workflows with multiple R UDF operators, each having its own separate R environment.</p><h3 id=solving-challenge-2-performance>Solving Challenge 2: Performance <a href=#solving-challenge-2-performance class=anchor aria-hidden=true>#</a></h3><p>To address performance issues, we needed an effective method to bridge <code>R</code>, <code>Arrow</code>, and <code>Python</code> together. We found that the <a href=https://github.com/rpy2/rpy2-arrow><code>rpy2-arrow</code></a> library, developed around 2020, functioned well for our purposes.</p><p>A significant advantage of <code>rpy2-arrow</code> is its adaptation of the Arrow RPC framework, which enables in-memory operations on Arrow data. Furthermore, <code>rpy2-arrow</code> achieves maximum efficiency by using pointers extensively, encouraging use of zero-copy operations. These advantages greatly reduce data transfer overhead between different langauge environments.</p><p><code>rpy2-arrow</code> is also an extension of the <code>rpy2</code> library, providing smooth usage when used together.</p><h3 id=a-demo-workflow-of-r-udfs>A Demo Workflow of R UDFs <a href=#a-demo-workflow-of-r-udfs class=anchor aria-hidden=true>#</a></h3><p>As a showcase of the successes of our proposed design, below in <em>Figure 2</em> is a sample workflow created by one of our users that exclusively uses R UDFs, all of which employed the tuple API.</p><figure align=center style=width:100%;max-width:none><img src=./rudf_sample_workflow.png alt style=width:100%><figcaption align=center style=font-size:1.2em><i><b>Figure 2.</b> A sample workflow using R UDFs only. All of the operators are using the tuple API.</i></figcaption></figure><p>This demo workflow was used in a research project intended to conduct Single Cell RNA analysis with R. The main driver for conducting the analysis came from the <a href=https://satijalab.org/seurat/><code>Seurat</code></a> package, which contains the eponymous <code>Seurat</code> object, an object that can store extensive data about single cells. In this workflow, the created <code>Seurat</code> object was frequently used as both input and output. Each step in the workflow utilized R UDFs to modify, extract, or inspect the <code>Seurat</code> object in some way, as can be seen from the labeled steps assigned to each R UDF operator.</p><p>Moreover, the branching sections of the workflow featured visual aids extracted from the <code>Seurat</code> object as output. These visualizations were then promptly embedded in HTML code created by their preceeding R UDF operators.</p><h2 id=supported-r-udf-apis>Supported R UDF APIs <a href=#supported-r-udf-apis class=anchor aria-hidden=true>#</a></h2><h3 id=tuple-api>Tuple API <a href=#tuple-api class=anchor aria-hidden=true>#</a></h3><h4 id=what-is-r-udf-tuple-api>What is R UDF Tuple API? <a href=#what-is-r-udf-tuple-api class=anchor aria-hidden=true>#</a></h4><p>The tuple API allows R code to process and return individual tuples one at a time, making it especially useful for stream-like data interfaces.</p><h4 id=how-does-r-udf-tuple-api-work>How does R UDF Tuple API Work? <a href=#how-does-r-udf-tuple-api-work class=anchor aria-hidden=true>#</a></h4><p>The goal of the tuple API is to enable users to write an R generator that yields an R <code>Tuple</code> or any structure convertible to an R <code>Tuple</code>. This is done through R&rsquo;s <code>coro</code> package, which supports writing Python-like generators in R. The written generator receives two arguments: the <code>tuple</code> itself and the <code>port</code>. Currently, the <code>port</code> argument is unused but may be utilized in the future. Lastly, users can also yield zero, one, or multiple tuples.</p><p>In the backend engine, the returned R <code>Tuple</code> is converted into a Python <code>Tuple</code>, with automatic type conversion and serialization from R to Python. When the next operator receives the <code>Tuple</code>, it is split into two subsequent <code>Tuples</code>: one containing non-binary data and the other containing binary data. The non-binary <code>Tuple</code> is converted into an Arrow <code>StructArray</code>, leveraging Arrow&rsquo;s advantages. The binary tuple undergoes manual deserialization to retrieve the original object(s). Finally, both <code>Tuples</code> are combined and passed into the R UDF as an argument. Note that for each <code>Tuple</code>, we only use one serialization and deserialization operation, thereby improving performance.</p><h4 id=when-should-r-udf-tuple-api-be-used>When should R UDF Tuple API be used? <a href=#when-should-r-udf-tuple-api-be-used class=anchor aria-hidden=true>#</a></h4><p>Users should employ the tuple API when they need to process, modify, or inspect data in individual units. Another suitable use case is when users want to quickly process data without waiting for an entire chunk as required by the table API.</p><h4 id=tuple-api-example-code>Tuple API: Example Code <a href=#tuple-api-example-code class=anchor aria-hidden=true>#</a></h4><p>Below is a simple example of using the tuple API in an R UDF. This scenario demonstrates how to yield five <code>Tuples</code> each containing a string, integer, and boolean component from the source. Then, for each <code>Tuple</code>, we can yield five additional <code>Tuples</code> after modifying each Tuple&rsquo;s integer component.</p><h5 id=source-r-udf-tuple-operator>Source R UDF Tuple Operator <a href=#source-r-udf-tuple-operator class=anchor aria-hidden=true>#</a></h5><p>Here, the user writes R code to yield a <code>List</code> with three attributes: <code>int_attr</code>, <code>str_attr</code>, and <code>bool_attr</code>. Note that since R does not natively support generators, we import the <code>coro</code> package. The body for the <code>function()</code> part of the code must be an anonymous function (similar to a Python lambda function).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-R data-lang=R><span class=line><span class=cl><span class=nf>library</span><span class=p>(</span><span class=n>coro</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>coro</span><span class=o>::</span><span class=nf>generator</span><span class=p>(</span><span class=nf>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>for </span><span class=p>(</span><span class=n>i</span> <span class=n>in</span> <span class=m>1</span><span class=o>:</span><span class=m>5</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>tuple</span> <span class=o>&lt;-</span> <span class=nf>list</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>int_attr</span> <span class=o>=</span> <span class=m>1L</span><span class=p>,</span>  <span class=c1># R integer</span>
</span></span><span class=line><span class=cl>            <span class=n>str_attr</span> <span class=o>=</span> <span class=s>&#34;A&#34;</span><span class=p>,</span> <span class=c1># R string</span>
</span></span><span class=line><span class=cl>            <span class=n>bool_attr</span> <span class=o>=</span> <span class=kc>TRUE</span> <span class=c1># R logical (boolean)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>yield</span><span class=p>(</span><span class=n>tuple</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div><p>Next, the user writes a function to increment the <code>int_attr</code> component of the <code>Tuple</code> by the index taken from a for loop. In this case, we can yield five separate <code>Tuples</code>, all of which modify the original <code>Tuple</code>. Again, the body of <code>function(tuple, port)</code> must be an anonymous function.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-R data-lang=R><span class=line><span class=cl><span class=nf>library</span><span class=p>(</span><span class=n>coro</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>coro</span><span class=o>::</span><span class=nf>generator</span><span class=p>(</span><span class=nf>function</span><span class=p>(</span><span class=n>tuple</span><span class=p>,</span> <span class=n>port</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>for </span><span class=p>(</span><span class=n>i</span> <span class=n>in</span> <span class=m>1</span><span class=o>:</span><span class=m>5</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>new_tuple</span> <span class=o>&lt;-</span> <span class=n>tuple</span>
</span></span><span class=line><span class=cl>        <span class=n>new_tuple</span><span class=o>$</span><span class=n>int_attr</span> <span class=o>&lt;-</span> <span class=n>new_tuple</span><span class=o>$</span><span class=n>int_attr</span> <span class=o>+</span> <span class=n>i</span>
</span></span><span class=line><span class=cl>        <span class=nf>yield </span><span class=p>(</span><span class=n>new_tuple</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div><h3 id=table-api>Table API <a href=#table-api class=anchor aria-hidden=true>#</a></h3><h4 id=what-is-r-udf-table-api>What is R UDF Table API? <a href=#what-is-r-udf-table-api class=anchor aria-hidden=true>#</a></h4><p>The Table API allows R code to process and return entire tables in a single operation. This functionality is particularly beneficial when dealing with large chunks of data that need to be processed or modified in bulk.</p><h4 id=how-does-r-udf-table-api-work>How does R UDF Table API Work? <a href=#how-does-r-udf-table-api-work class=anchor aria-hidden=true>#</a></h4><p>The objective of the table API is for the user to write an R function that returns an R <code>data.frame</code> or any structure convertible to a <code>data.frame</code> in R, such as an R <code>list</code>, <code>matrix</code>, or <code>vector</code>. The provided function should accept two arguments: the <code>table</code> itself and the <code>port</code>. Currently, the <code>port</code> argument is unused but may be utilized in the future.</p><p>In the engine&rsquo;s backend, the returned R <code>data.frame</code> is converted into an PyArrow <code>Table</code> using <code>rpy2-arrow</code>, facilitating seamless data transfer to the next operator.</p><h4 id=when-should-r-udf-table-api-be-used>When should R UDF Table API be used? <a href=#when-should-r-udf-table-api-be-used class=anchor aria-hidden=true>#</a></h4><p>Users should employ the table API when they need to process or pass along bulk data in large, tabular chunks. Another suitable use case for the table API is when users need to modify an entire <code>Table</code> and return the entire modified result.</p><h4 id=table-api-example-code>Table API: Example Code <a href=#table-api-example-code class=anchor aria-hidden=true>#</a></h4><p>Below is an example of simple usage of the table API in an R UDF. In this scenario, we aim to return a simple table from R containing three attributes and three rows of data. We then add a new row, resulting in a total of four rows of data.</p><p>The Source R UDF Table Operator example is as follows. Here, the user writes R code to return a <code>data.frame</code> with three attributes: <code>Training</code>, <code>Pulse</code>, and <code>Stamina</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-R data-lang=R><span class=line><span class=cl><span class=nf>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>table</span> <span class=o>&lt;-</span> <span class=nf>data.frame</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>Training</span> <span class=o>=</span> <span class=nf>c</span><span class=p>(</span><span class=s>&#34;Strength&#34;</span><span class=p>,</span> <span class=s>&#34;Stamina&#34;</span><span class=p>,</span> <span class=s>&#34;Other&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>Pulse</span> <span class=o>=</span> <span class=nf>c</span><span class=p>(</span><span class=m>100L</span><span class=p>,</span> <span class=m>150L</span><span class=p>,</span> <span class=m>120L</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>Duration</span> <span class=o>=</span> <span class=nf>c</span><span class=p>(</span><span class=m>60</span><span class=p>,</span> <span class=m>30</span><span class=p>,</span> <span class=m>45</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>return</span><span class=p>(</span><span class=n>table</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Next, in the R UDF Table Operator, the user writes a function to add a new row to the source Table:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-R data-lang=R><span class=line><span class=cl><span class=nf>function</span><span class=p>(</span><span class=n>table</span><span class=p>,</span> <span class=n>port</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1># Note that the port argument is unused, this is intentional for now</span>
</span></span><span class=line><span class=cl>    <span class=n>new_row</span> <span class=o>&lt;-</span> <span class=nf>data.frame</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>Training</span> <span class=o>=</span> <span class=s>&#34;TEST&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Pulse</span> <span class=o>=</span> <span class=m>123L</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Duration</span> <span class=o>=</span> <span class=m>999</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>table</span> <span class=o>&lt;-</span> <span class=nf>rbind</span><span class=p>(</span><span class=n>table</span><span class=p>,</span> <span class=n>new_row</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>return</span><span class=p>(</span><span class=n>table</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The final table will now contain a total of four rows.</p><p>In the final tuple, the <code>int_attr</code> will be incremented from 1 to 2.</p><h2 id=conclusion>Conclusion <a href=#conclusion class=anchor aria-hidden=true>#</a></h2><p>The introduction of R UDF support in Texera marks a significant milestone, opening up new opportunities and use cases for the platform. This development paves the way for a broader range of users and applications, enriching the Texera ecosystem.</p><p>We hope that this work and insights serve as a solid foundation for further enhancements by other developers. It is our hope that future improvements will continue to be built on top of this foundation, expanding Texera&rsquo;s capabilities.</p><h2 id=acknowledgements>Acknowledgements <a href=#acknowledgements class=anchor aria-hidden=true>#</a></h2><p>We want to credit Prof. Chen Li for guiding us throughout this journey, Kun Woo (Chris) Park for being a user of R UDF, Cornell colleagues Prof. Shuibing Chen, Sally Lee, Dongliang Leng, for providing single-cell analysis R programs converted to the workflow in <em>Figure 2</em>, and the entire Texera Team.</p></article></div></div></div></div><footer class="footer text-muted"><div class=container-fluid><div class=row><div class="col-lg-8 order-last order-lg-first"><ul class=list-inline><li class=list-inline-item></li></ul></div><div class="col-lg-8 order-first order-lg-last text-lg-end"><ul class=list-inline></ul></div></div></div></footer><script src=/js/bootstrap.min.0a0106334435d4110713bfaff4acaf02533b0c56d44412a74e9518db07672ddb7e099a9c7517bc9cb529e2ddd4ae2e438b40b720288900d5e74fb6d8928d9097.js integrity="sha512-CgEGM0Q11BEHE7+v9KyvAlM7DFbURBKnTpUY2wdnLdt+CZqcdRe8nLUp4t3Uri5Di0C3ICiJANXnT7bYko2Qlw==" crossorigin=anonymous defer></script>
<script src=/js/highlight.min.576fdb91cfd303e8fc247b90cc678e7d3304777de963077ad78eb70811a476919edaebf1d2843057250ec536b7ed1bd40f4e48f06e7cfc9c569dcf7581afd08b.js integrity="sha512-V2/bkc/TA+j8JHuQzGeOfTMEd33pYwd61463CBGkdpGe2uvx0oQwVyUOxTa37RvUD05I8G58/JxWnc91ga/Qiw==" crossorigin=anonymous defer></script>
<script src=/main.min.0382ba481d9dbcd1dd4c82111208ebf5d7eda2fce9378b0b14257d7f117c79f8ae01591f6ad0a99917b4e1624d8ace90de964e2431ab237000161ebd3c3dad63.js integrity="sha512-A4K6SB2dvNHdTIIREgjr9dftovzpN4sLFCV9fxF8efiuAVkfatCpmRe04WJNis6Q3pZOJDGrI3AAFh69PD2tYw==" crossorigin=anonymous defer></script></body></html>